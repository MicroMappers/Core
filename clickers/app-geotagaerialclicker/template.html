<style type="text/css">
   .span12 {width: 1036px;}
    h1,h2,h3,h4,h5,h6 {font-family: 'Museo Slab', Arial, Helvetica, sans-serif;font-weight: normal;}
    h1 {font-size: 24px; line-height: 26px;}
    h2 {font-size: 18px; line-height: normal;}
    h3 {font-size: 15px; line-height: normal;}
    .alignright {float: right;}
    .alignleft {float: left;}
    .aligncenter {display: block; margin: 0 auto; clear: both}
    .clearleft {clear: left;}
    .clearright {clear: right;}
    .clearboth {clear: both;}
    .subheader {
       /*margin: 10px 0 0 200px;*/
    }
    #iphone {
       max-width: 100%;
       background: url(../../../../static/img/micromappers/aerialClicker/holding-ipad.png) left top no-repeat;
       width: 1036px;
       height: 778px;
       float:left;
    }
    #taggedimg {
       max-width: 100%;
       width: 700px;
       height: 534px;
       margin: 64px 0 0 176px;
       float:left;
       background-color: #111;
    }
    #btn-group {
       padding: 18px 0 0 20px;
       margin:0 auto;
       clear: left;
       margin-left: 345px;
    }
    #btn-group a.btn {
       width:72px;
    }
    #tagged {
       margin: 50px 0 0;
       padding: 20px 0 0;
       clear: left;
    }
    #tagged p {
        text-align: center;
    }
    input {
       max-width: 100%;
    }
    .btn {
       margin: 0 6px 0 0;
    }

    .map_canvas label {
        width: auto;
        display: inline;
    }
    .map_canvas img {
        max-width: none;
    }

    .olImageLoadError {
        /* when OL encounters a 404, don't display the pink image */
        display: none !important;
    }

    #loadingMap{
        position:absolute;
        z-index: 10000;
        width: 100%;
        height: 100%;
        margin-top: 0px;
        margin-left: 0px;
        background-color: rgba(255,255,255,1);
    }

    #facts {
        position: relative;
        margin-top:200px;
    }

    .layersDiv label {
        color: white;
    }
</style>
<div class="span3" style="margin-left: 950px">
    <div style="text-align:center;margin-right:170px;padding-bottom: 10px;">
         <a class="btn btn-primary" href="../tutorial" ><i class="icon-question-sign"></i> Tutorial</a>
    </div>
    <div style="
        margin-right: 4px;
        padding: 7px;
        background-color: #0FC5BA;
        border: 1px solid #D5CECE;
        -webkit-border-radius: 4px;
        -moz-border-radius: 4px; border-radius: 4px; -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05); -moz-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05); box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05);
    ">
        <input type="hidden" id="task-id">
        <p>Completed: <span id="done" class="label label-info"></span> out of
        <span id="total" class="label label-inverse"></span> Clicks</p>
        <p><span id="remain" class="label label-info"></span> Clicks remaining!</p>
        <p><b>Rank : <span id="rank"></span></b></p>
    </div>
</div>
<div class="row">
    <!-- Success and Error Messages for the user -->
    <div class="span12" style="height:50px">
        <div id="success" class="alert alert-success" style="display:none;">
            <a class="close">×</a>
            <strong>Well done!</strong> Your answer has been saved
        </div>
        <div id="loading" class="alert alert-info" style="display:none;">
            <a class="close">×</a>
            Loading next task...
        </div>
        <div id="taskcompleted" class="alert alert-info" style="display:none;">
            <strong>The task has been completed!</strong> Thanks a lot!
        </div>
        <div id="finish" class="alert alert-success" style="display:none;">
            <strong>Congratulations!</strong> You have participated in all available tasks!
            <br/>
            <div class="alert-actions">
                <a class="btn small" href="/">Go back</a>
                <a class="btn small" href="/app">or, Check other applications</a>
            </div>
        </div>
        <div id="error" class="alert alert-error" style="display:none;">
            <a class="close">×</a>
            <strong>Error!</strong> Something went wrong, please contact the site administrators
        </div>
    </div> <!-- End Success and Error Messages for the user -->
</div> <!-- End of Row -->

<div class="row skeleton">
    <div class="span12" style="margin-top: -180px;">
            <div id="iphone">
               <div id="taggedimg"></div>
               <div id="btn-group" class="text-center">
                   <button id="skipbtn" class="btn btn-danger btn-submit" value="skip">
                       <i class="icon-check icon-white"></i> Nothing here
                   </button>
                   <button id="answerbtn" class="btn btn-success btn-submit" value="coordinates">
                       <i class="icon-check icon-white"></i> Add my drawings
                   </button>
               </div>
            </div>
            <br/>
            <div class="clearboth"></div>
     </div>
</div>
<script src="http://d3js.org/d3.v2.js"></script>
<script src="/static/js/pybossa/pybossa.js" type="text/javascript"></script>
<link rel="stylesheet" href="/static/micromappers/css/leaflet.css" />
<link rel="stylesheet" href="/static/micromappers/css/leaflet.draw.css" />

<!--[if lte IE 8]>
<link rel="stylesheet" href="/static/micromappers/css/leaflet.ie.css" />
<link rel="stylesheet" href="/static/micromappers/css/leaflet.draw.ie.css" />
<![endif]-->

<script src="/static/micromappers/js/leaflet.js"></script>
<script src="/static/micromappers/js/leaflet.draw.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&libraries=drawing"></script>
<!-- PyBossa interface -->
<script>
var theTask;
var step = 0;
var steps = 2;

function loadUserProgress() {
    pybossa.userProgress('MM_AerialGeoClicker').done(function(data){
        var f = d3.format("2.2s");
        var pct = Math.round((data.done*100)/data.total);
        $("#progress").css("width", pct.toString() +"%");
        $("#progress").attr("title", pct.toString() + "% completed!");
        $("#progress").tooltip({'placement': 'left'});
        $("#total").text(data.total);
        $("#done").text(data.done);

        var remaining = data.total - data.done;
             $("#remain").text(remaining);

             var completed = data.done;
             var rankTitle = "Volunteer";

             if(completed>10 && completed <= 29){
                rankTitle = "Red Cross Intern";
             }
             else if(completed>30 && completed <= 59){
                rankTitle = "New FEMA Recruit";
             }
             else if(completed>60 && completed <= 99){
                rankTitle = "UN Humanitarian";
             }
             else if(completed>100 && completed <= 299){
                rankTitle = "Senior UN Official";
             }
             else if(completed>300 && completed <= 499){
                rankTitle = "UN Country Director";
             }
             else if(completed>500 && completed <= 999){
                rankTitle = "Head of UN OCHA";
             }
             else if(completed>1000 ){
                rankTitle = "UN Secretary General";
             }

        $("#rank").text(rankTitle);
    });
}


pybossa.taskLoaded(function(task, deferred){
    if ( !$.isEmptyObject(task) ) {
        var map_div = $("<div/>", {id:"map_task_" + task.id, 'class': 'span4', 'style':'margin-left:0px'});
        var map_canvas = $("<div/>", {id: "map_" + task.id, 'class': 'map_canvas'});
        map_canvas.css("width", "700px");
        map_canvas.css("height", "534px");
        map_div.append(map_canvas);
        $("#taggedimg").prepend(map_div);

        var geoBounds = task.info.geo;
        var geoBoundsArray = $.parseJSON(geoBounds);

        var swBound = new google.maps.LatLng(geoBoundsArray[3],geoBoundsArray[2]);
        var neBound = new google.maps.LatLng(geoBoundsArray[1],geoBoundsArray[0]);
        var bounds = new google.maps.LatLngBounds(swBound, neBound);


        var centerPoint = bounds.getCenter();

        var imageUrl = task.info.url ;
        var imageBounds = [[geoBoundsArray[3], geoBoundsArray[2]], [geoBoundsArray[1], geoBoundsArray[0]]];
      //  var center = imageBounds.getCenter();
        //[11.10089666095, 124.99372064434999]
        var map = L.map("map_" + task.id,{maxZoom: 24}).setView([centerPoint.lat(), centerPoint.lng()], 21);

        L.imageOverlay(imageUrl, imageBounds,{opacity: 0.7}).addTo(map);
        L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        // Initialize the draw control and pass it the FeatureGroup of editable layers

        var drawControl = new L.Control.Draw({
            draw : {
                position : 'topleft',
                polygon : true,
                polyline : true,
                rectangle : true,
                circle : true

            },
            edit: {
                featureGroup: drawnItems
            }
        });
        //var drawControl = new L.Control.Draw({
         //   edit: {
         //       featureGroup: drawnItems
         //   }
       // });

        map.addControl(drawControl);

        map.on('draw:created', function (e) {
            var type = e.layerType,
                layer = e.layer;



            // Do whatever else you need to. (save to db, add to map etc)
            drawnItems.addLayer(layer);
            task.drawnItems = drawnItems;

           // console.log(e.layer.getPathString());
           // console.log(e.layer.getBounds());
            //console.log(e.layer.getLatLngs());
            console.log("created : " + e.layer.toGeoJSON());

            map.removeControl(drawControl);
            drawControl = new L.Control.Draw({
                draw : {
                    position : 'topleft',
                    polygon : false,
                    polyline : false,
                    rectangle : false,
                    circle : false,
                    marker : false
                },
                edit: {
                    featureGroup: drawnItems
                }
            });

            map.addControl(drawControl);

        });

        map.on('draw:edited', function (e) {
         var type = e.layerType,
         layer = e.layer;
        // console.log("updated : " + e.layer.toGeoJSON());
        // drawnItems.addLayer(layer);
        // task.drawnItems = drawnItems;
        // Update db to save latest changes.
            task.drawnItems = drawnItems;
        });

        map.on('draw:deleted', function (e) {
            var type = e.layerType,
                layer = e.layer;
            drawnItems.removeLayer(layer);
            task.drawnItems = drawnItems;

            map.removeControl(drawControl);
            drawControl = new L.Control.Draw({
                draw : {
                    position : 'topleft',
                    polygon : true,
                    polyline : true,
                    rectangle : true,
                    circle : true,
                    marker : true
                },
                edit: {
                    featureGroup: drawnItems
                }
            });

            map.addControl(drawControl);

        // Update db to save latest changes.
        });

        map.setMaxBounds(imageBounds);

        map_div.hide();
        deferred.resolve(task);
    }

    else {
        deferred.resolve(task);
    }


});

pybossa.presentTask(function(task, deferred){
    if ( !$.isEmptyObject(task) ) {
        $("#task-id").text(task.id);
        loadUserProgress();


        $("#map_task_" + task.id).show();


        $(".btn-submit").off('click').on('click', function(evt){
            var ctrlClicked = $(evt.target).attr("id");
            var btnClicked = $(evt.target).attr("value");
            var answer = '';
            console.log("The answer for task " + task.id + " is " + btnClicked);
            if(ctrlClicked == 'answerbtn'){
                if (task.drawnItems) {
                    task.drawnItems.eachLayer(function (layer) {
                        console.log(layer);
                        answer = layer.toGeoJSON();
                        console.log(layer.toGeoJSON());
                    });
                 }
            }

            task.answer = {
            'tweet': task.info.tweet,
            'tweetid': task.info.tweetid,
            'taskid': task.id,
            'author': task.info.author,
            'url': task.info.url,
            'timestamp': task.info.timestamp,
            'lon': task.info.lon,
            'lat': task.info.lat,
            'imgurl': task.info.imgurl,
            'locationRef': null,
            'loc': answer,
            'geo': task.info.geo
          };

            pybossa.saveTask(task.id, task.answer).done( function(data) {
                // Show the feedback div
                    $("#success").fadeIn();
                    // Fade out the pop-up after a 1000 miliseconds
                    setTimeout(function() { $("#success").fadeOut() }, 1000);
                    $("#map_" + task.id).remove();
                    deferred.resolve();
            });

        });

        $("#map_task_" + task.id).show();
    }
    else {
        $(".skeleton").hide();
        $("#finish").fadeIn();
    }
});



pybossa.run('MM_AerialGeoClicker');

</script>