<style type="text/css">
   .span12 {width: 1036px;}
    h1,h2,h3,h4,h5,h6 {font-family: 'Museo Slab', Arial, Helvetica, sans-serif;font-weight: normal;}
    h1 {font-size: 24px; line-height: 26px;}
    h2 {font-size: 18px; line-height: normal;}
    h3 {font-size: 15px; line-height: normal;}
    .alignright {float: right;}
    .alignleft {float: left;}
    .aligncenter {display: block; margin: 0 auto; clear: both}
    .clearleft {clear: left;}
    .clearright {clear: right;}
    .clearboth {clear: both;}
    .subheader {
       /*margin: 10px 0 0 200px;*/
    }
    #iphone {
       max-width: 100%;
       background: url(../../../../static/img/micromappers/aerialClicker/holding-ipad.png) left top no-repeat;
       width: 1036px;
       height: 778px;
       float:left;
    }
    #taggedimg {
       max-width: 100%;
       width: 700px;
       height: 534px;
       margin: 64px 0 0 176px;
       float:left;
       background-color: #111;
    }
    #btn-group {
       padding: 18px 0 0 20px;
       margin:0 auto;
       clear: left;
       margin-left: 360px;
    }
    #btn-group a.btn {
       width:72px;
    }
    #tagged {
       margin: 50px 0 0;
       padding: 20px 0 0;
       clear: left;
    }
    #tagged p {
        text-align: center;
    }
    input {
       max-width: 100%;
    }
    .btn {
       margin: 0 6px 0 0;
    }

    .map_canvas label {
        width: auto;
        display: inline;
    }
    .map_canvas img {
        max-width: none;
    }

    .olImageLoadError {
        /* when OL encounters a 404, don't display the pink image */
        display: none !important;
    }

    #loadingMap{
        position:absolute;
        z-index: 10000;
        width: 100%;
        height: 100%;
        margin-top: 0px;
        margin-left: 0px;
        background-color: rgba(255,255,255,1);
    }

    #facts {
        position: relative;
        margin-top:200px;
    }

    .layersDiv label {
        color: white;
    }
</style>
<div class="span3" style="margin-left: 950px">
    <div style="text-align:center;margin-right:170px;padding-bottom: 10px;">
         <a class="btn btn-primary" href="../tutorial" ><i class="icon-question-sign"></i> Tutorial</a>
    </div>
    <div style="
        margin-right: 4px;
        padding: 7px;
        background-color: #0FC5BA;
        border: 1px solid #D5CECE;
        -webkit-border-radius: 4px;
        -moz-border-radius: 4px; border-radius: 4px; -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05); -moz-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05); box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05);
    ">
        <input type="hidden" id="task-id">
        <p>Completed: <span id="done" class="label label-info"></span> out of
        <span id="total" class="label label-inverse"></span> Clicks</p>
        <p><span id="remain" class="label label-info"></span> Clicks remaining!</p>
        <p><b>Rank : <span id="rank"></span></b></p>
    </div>
</div>
<div class="row">
    <!-- Success and Error Messages for the user -->
    <div class="span12" style="height:50px">
        <div id="success" class="alert alert-success" style="display:none;">
            <a class="close">×</a>
            <strong>Well done!</strong> Your answer has been saved
        </div>
        <div id="loading" class="alert alert-info" style="display:none;">
            <a class="close">×</a>
            Loading next task...
        </div>
        <div id="taskcompleted" class="alert alert-info" style="display:none;">
            <strong>The task has been completed!</strong> Thanks a lot!
        </div>
        <div id="finish" class="alert alert-success" style="display:none;">
            <strong>Congratulations!</strong> You have participated in all available tasks!
            <br/>
            <div class="alert-actions">
                <a class="btn small" href="/">Go back</a>
                <a class="btn small" href="/app">or, Check other applications</a>
            </div>
        </div>
        <div id="error" class="alert alert-error" style="display:none;">
            <a class="close">×</a>
            <strong>Error!</strong> Something went wrong, please contact the site administrators
        </div>
    </div> <!-- End Success and Error Messages for the user -->
</div> <!-- End of Row -->

<div class="row skeleton">
    <div class="span12" style="margin-top: -180px;">
            <div id="iphone">
               <div id="taggedimg"></div>
               <div id="btn-group" class="text-center">
                    <button id="delete" class="btn btn-inverse btn-map-ctrl ">
                      <i class="icon icon-white icon-trash"></i> Delete
                    </button>
                   <button id="skipbtn" class="btn btn-danger btn-submit" value="skip">
                       <i class="icon-check icon-white"></i> Skip
                   </button>
                   <button id="answerbtn" class="btn btn-success btn-submit" value="coordinates">
                       <i class="icon-check icon-white"></i> Save
                   </button>
               </div>
            </div>
            <br/>
            <div class="clearboth"></div>
     </div>
</div>
<script src="http://d3js.org/d3.v2.js"></script>
<script src="/static/js/pybossa/pybossa.js" type="text/javascript"></script>
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&libraries=drawing"></script>
<!-- PyBossa interface -->
<script>
var theTask;
var step = 0;
var steps = 2;
var mapStyle = [{  stylers: [{ color: "#000000" }] }];
USGSOverlay.prototype = new google.maps.OverlayView();

function clearSelection() {
    if (theTask.selectedShape) {
          theTask.selectedShape.setEditable(false);
          theTask.selectedShape = null;
    }
}

function setSelection(shape) {
    clearSelection();
    theTask.selectedShape = shape;
    shape.setEditable(true);
}

function deleteSelectedShape() {
    if (theTask.selectedShape) {
      theTask.selectedShape.setMap(null);
    }
}

function loadUserProgress() {
    pybossa.userProgress('MM_AerialGeoClicker').done(function(data){
        var f = d3.format("2.2s");
        var pct = Math.round((data.done*100)/data.total);
        $("#progress").css("width", pct.toString() +"%");
        $("#progress").attr("title", pct.toString() + "% completed!");
        $("#progress").tooltip({'placement': 'left'});
        $("#total").text(data.total);
        $("#done").text(data.done);

        var remaining = data.total - data.done;
             $("#remain").text(remaining);

             var completed = data.done;
             var rankTitle = "Volunteer";

             if(completed>10 && completed <= 29){
                rankTitle = "Red Cross Intern";
             }
             else if(completed>30 && completed <= 59){
                rankTitle = "New FEMA Recruit";
             }
             else if(completed>60 && completed <= 99){
                rankTitle = "UN Humanitarian";
             }
             else if(completed>100 && completed <= 299){
                rankTitle = "Senior UN Official";
             }
             else if(completed>300 && completed <= 499){
                rankTitle = "UN Country Director";
             }
             else if(completed>500 && completed <= 999){
                rankTitle = "Head of UN OCHA";
             }
             else if(completed>1000 ){
                rankTitle = "UN Secretary General";
             }

        $("#rank").text(rankTitle);
    });
}

pybossa.taskLoaded(function(task, deferred){
    if ( !$.isEmptyObject(task) ) {
        var map_div = $("<div/>", {id:"map_task_" + task.id, 'class': 'span4', 'style':'margin-left:0px'});
        var map_canvas = $("<div/>", {id: "map_" + task.id, 'class': 'map_canvas'});
        map_canvas.css("width", "700px");
        map_canvas.css("height", "534px");
        map_div.append(map_canvas);
        $("#taggedimg").prepend(map_div);

        var geoBounds = task.info.geo;
        var geoBoundsArray = geoBounds.split(',');

        console.log(geoBoundsArray[0]);
        console.log(geoBoundsArray[1]);
        console.log(geoBoundsArray[2]);
        console.log(geoBoundsArray[3]);

        //var swBound = new google.maps.LatLng(10.9509251863,124.933284243);
        //var neBound = new google.maps.LatLng(11.2508681356,125.0541570457);
        var swBound = new google.maps.LatLng(geoBoundsArray[0],geoBoundsArray[1]);
        var neBound = new google.maps.LatLng(geoBoundsArray[2],geoBoundsArray[3]);
        var bounds = new google.maps.LatLngBounds(swBound, neBound);


        var centerPoint = bounds.getCenter();


        var mapOptions = {
              zoom: 13,
              center: centerPoint,
              mapTypeId: google.maps.MapTypeId.ROADMAP,
              disableDefaultUI: true,
              zoomControl: true,
              zoomControlOptions: {
                style: google.maps.ZoomControlStyle.LARGE,
                position: google.maps.ControlPosition.TOP_LEFT
              }
         }


        var map = new google.maps.Map(document.getElementById("map_" + task.id),
                    mapOptions);
        map.setOptions({styles: mapStyle});

        var polyOptions = {
          strokeWeight: 0,
          fillOpacity: 0.45,
          editable: true
        };


        task.drawingManager = new google.maps.drawing.DrawingManager({
        drawingMode: google.maps.drawing.OverlayType.POLYGON,
        drawingControl: true,

        drawingControlOptions: {
              position: google.maps.ControlPosition.TOP_CENTER,
              drawingModes: [
                google.maps.drawing.OverlayType.POLYGON
              ],
              polygonOptions: {
                    fillColor: '#0099FF',
                    fillOpacity: 0.7,
                    strokeColor: '#AA2143',
                    strokeWeight: 2,
                    clickable: true,
                    zIndex: 1,
                    editable: true
              }
            }
        });

        task.drawingManager = new google.maps.drawing.DrawingManager({
              drawingMode: google.maps.drawing.OverlayType.POLYGON,
              drawingControlOptions: {
              position: google.maps.ControlPosition.TOP_CENTER,
              drawingModes: [
                    google.maps.drawing.OverlayType.POLYGON
                  ],
                  polygonOptions:polyOptions
              } ,
              map: map
        });

        task.drawingManager.setMap(map);

        google.maps.event.addListener(task.drawingManager, 'overlaycomplete', function(e) {
            var newShape = e.overlay;

            newShape.type = e.type;
              //newShape.setEditable(true);

            google.maps.event.addListener(newShape, 'click', function() {
                setSelection(newShape);
             });

            setSelection(newShape);

        });

        var srcImage = task.info.url ;
        var overlay = new USGSOverlay(bounds, srcImage, map);

        map_div.hide();
        deferred.resolve(task);
    }

    else {
        deferred.resolve(task);
    }


});

pybossa.presentTask(function(task, deferred){
    if ( !$.isEmptyObject(task) ) {
        $("#task-id").text(task.id);
        loadUserProgress();

        theTask = task;

        $("#map_task_" + task.id).show();
            $(".btn-map-ctrl").off('click').on('click', function(evt){
                var ctrlClicked = $(evt.target).attr("id");
                deleteSelectedShape();
        });


        $(".btn-submit").off('click').on('click', function(evt){
            var btnClicked = $(evt.target).attr("value");
            console.log("The answer for task " + task.id + " is " + btnClicked);
            if (task.selectedShape) {
                var
                coords  = new Array(),
                payload = { type: "MultiPolygon", coordinates: new Array()};

                payload.coordinates.push(new Array());
                payload.coordinates[0].push(new Array());
                var path = task.selectedShape.getPath();
                for (var i = 0; i < path.length; i++) {
                  coord = path.getAt(i);
                  coords.push( coord.lng() + " " + coord.lat() );
                  payload.coordinates[0][0].push([coord.lng(),coord.lat()])
                }

                var q = "geojson=" + JSON.stringify(payload);

                console.log(q);
                task.answer = q;
           }
            /**
            pybossa.saveTask(task.id, task.answer).done( function(data) {
                // Show the feedback div
                    $("#success").fadeIn();
                    // Fade out the pop-up after a 1000 miliseconds
                    setTimeout(function() { $("#success").fadeOut() }, 1000);
                    $("#map_" + task.id).remove();
                    deferred.resolve();

            }); **/
        });
        $("#map_task_" + task.id).show();
    }
    else {
        $(".skeleton").hide();
        $("#finish").fadeIn();
    }
});

function USGSOverlay(bounds, image, map) {
          this.bounds_ = bounds;
          this.image_ = image;
          this.map_ = map;

          this.div_ = null;

          this.setMap(map);
}

USGSOverlay.prototype.onAdd = function() {

      var div = document.createElement('div');
      div.style.borderStyle = 'none';
      div.style.borderWidth = '0px';
      div.style.position = 'absolute';

      // Create the img element and attach it to the div.
      var img = document.createElement('img');
      img.src = this.image_;
      img.style.width = '100%';
      img.style.height = '100%';
      img.style.position = 'absolute';
      div.appendChild(img);

      this.div_ = div;

      // Add the element to the "overlayLayer" pane.
      var panes = this.getPanes();
      panes.overlayLayer.appendChild(div);
};

USGSOverlay.prototype.draw = function() {
  var overlayProjection = this.getProjection();
  var sw = overlayProjection.fromLatLngToDivPixel(this.bounds_.getSouthWest());
  var ne = overlayProjection.fromLatLngToDivPixel(this.bounds_.getNorthEast());

  // Resize the image's div to fit the indicated dimensions.
  var div = this.div_;
  div.style.left = sw.x + 'px';
  div.style.top = ne.y + 'px';
  div.style.width = (ne.x - sw.x) + 'px';
  div.style.height = (sw.y - ne.y) + 'px';
};

USGSOverlay.prototype.onRemove = function() {
  this.div_.parentNode.removeChild(this.div_);
  this.div_ = null;
};

pybossa.run('MM_AerialGeoClicker');

</script>